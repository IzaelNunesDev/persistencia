{% extends "base.html" %}

{% block title %}Sustentabilidade Financeira - Saneamento Ceará{% endblock %}

{% block content %}
<div class="container">
    <header class="hero">
        <h1>💰 Sustentabilidade Financeira</h1>
        <p>Análise da viabilidade financeira dos serviços de saneamento no Ceará</p>
    </header>

    <main>
        <!-- Filtros -->
        <section>
            <article>
                <div class="filtros-container">
                    <div class="form-group">
                        <label for="ano">Ano:</label>
                        <select id="ano" class="form-control">
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                        </select>
                    </div>
                    <button id="atualizar-btn" class="btn btn-primary">Atualizar Análise</button>
                </div>
            </article>
        </section>

        <!-- Indicadores de Sustentabilidade -->
        <section class="grid">
            <article>
                <header>
                    <h2>📊 Indicadores Financeiros</h2>
                </header>
                <div id="indicadores-financeiros" class="indicadores-grid">
                    <div class="loading">Carregando...</div>
                </div>
            </article>

            <article>
                <header>
                    <h2>📈 Evolução Financeira</h2>
                </header>
                <div class="chart-container">
                    <canvas id="evolucaoFinanceiraChart"></canvas>
                </div>
            </article>
        </section>

        <!-- Análise de Receitas vs Despesas -->
        <section class="grid">
            <article>
                <header>
                    <h2>💵 Receitas vs Despesas</h2>
                </header>
                <div class="chart-container">
                    <canvas id="receitasDespesasChart"></canvas>
                </div>
            </article>

            <article>
                <header>
                    <h2>🏆 Top 10 - Sustentabilidade</h2>
                </header>
                <div id="ranking-sustentabilidade" class="ranking-container">
                    <div class="loading">Carregando...</div>
                </div>
            </article>
        </section>

        <!-- Análise Detalhada -->
        <section>
            <article>
                <header>
                    <h2>🔍 Análise Detalhada</h2>
                </header>
                <div id="analise-detalhada" class="analise-detalhada">
                    <div class="loading">Carregando análise...</div>
                </div>
            </article>
        </section>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarAnaliseSustentabilidade();
    
    document.getElementById('atualizar-btn').addEventListener('click', carregarAnaliseSustentabilidade);
    document.getElementById('ano').addEventListener('change', carregarAnaliseSustentabilidade);
});

async function carregarAnaliseSustentabilidade() {
    const ano = document.getElementById('ano').value;
    
    try {
        // Carregar dados de sustentabilidade
        const response = await fetch(`/api/v1/analises/sustentabilidade-financeira?ano=${ano}`);
        const dados = await response.json();
        
        // Atualizar indicadores
        atualizarIndicadoresFinanceiros(dados);
        
        // Criar gráficos
        criarGraficoEvolucaoFinanceira(dados);
        criarGraficoReceitasDespesas(dados);
        
        // Carregar ranking
        carregarRankingSustentabilidade(ano);
        
        // Gerar análise detalhada
        gerarAnaliseDetalhada(dados);
        
    } catch (error) {
        console.error('Erro ao carregar análise de sustentabilidade:', error);
    }
}

function atualizarIndicadoresFinanceiros(dados) {
    const container = document.getElementById('indicadores-financeiros');
    
    const indicadores = [
        {
            nome: 'Receita Operacional Total',
            valor: dados.receita_operacional_total,
            formato: 'moeda',
            cor: 'success'
        },
        {
            nome: 'Despesa Total',
            valor: dados.despesa_total,
            formato: 'moeda',
            cor: 'warning'
        },
        {
            nome: 'Saldo Operacional',
            valor: dados.saldo_operacional,
            formato: 'moeda',
            cor: dados.saldo_operacional >= 0 ? 'success' : 'danger'
        },
        {
            nome: 'Investimento Total',
            valor: dados.investimento_total,
            formato: 'moeda',
            cor: 'info'
        },
        {
            nome: 'Índice de Cobertura',
            valor: dados.indice_cobertura,
            formato: 'percentual',
            cor: dados.indice_cobertura >= 1 ? 'success' : 'danger'
        },
        {
            nome: 'Eficiência Operacional',
            valor: dados.eficiencia_operacional,
            formato: 'percentual',
            cor: dados.eficiencia_operacional >= 0.8 ? 'success' : 'warning'
        }
    ];
    
    container.innerHTML = indicadores.map(ind => `
        <div class="indicador-card ${ind.cor}">
            <h3>${ind.nome}</h3>
            <p class="valor">${formatarValor(ind.valor, ind.formato)}</p>
        </div>
    `).join('');
}

function criarGraficoEvolucaoFinanceira(dados) {
    const ctx = document.getElementById('evolucaoFinanceiraChart').getContext('2d');
    
    if (window.evolucaoFinanceiraChart) {
        window.evolucaoFinanceiraChart.destroy();
    }
    
    window.evolucaoFinanceiraChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dados.evolucao_anos || ['2019', '2020', '2021', '2022'],
            datasets: [
                {
                    label: 'Receitas (R$)',
                    data: dados.evolucao_receitas || [0, 0, 0, 0],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Despesas (R$)',
                    data: dados.evolucao_despesas || [0, 0, 0, 0],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolução Financeira'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                }
            }
        }
    });
}

function criarGraficoReceitasDespesas(dados) {
    const ctx = document.getElementById('receitasDespesasChart').getContext('2d');
    
    if (window.receitasDespesasChart) {
        window.receitasDespesasChart.destroy();
    }
    
    window.receitasDespesasChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Receitas', 'Despesas'],
            datasets: [{
                data: [
                    dados.receita_operacional_total || 0,
                    dados.despesa_total || 0
                ],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribuição Receitas vs Despesas'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

async function carregarRankingSustentabilidade(ano) {
    try {
        const response = await fetch(`/api/v1/analises/ranking?indicador=sustentabilidade&ano=${ano}&limit=10`);
        const ranking = await response.json();
        
        const container = document.getElementById('ranking-sustentabilidade');
        container.innerHTML = '';
        
        ranking.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'ranking-card';
            card.innerHTML = `
                <div class="ranking-position">${index + 1}</div>
                <div class="ranking-info">
                    <h3>${item.nome_municipio}</h3>
                    <p>Índice: ${(item.indice_sustentabilidade * 100).toFixed(1)}%</p>
                    <p>Saldo: ${formatarMoeda(item.saldo_operacional)}</p>
                </div>
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error('Erro ao carregar ranking de sustentabilidade:', error);
    }
}

function gerarAnaliseDetalhada(dados) {
    const container = document.getElementById('analise-detalhada');
    
    const analise = `
        <div class="analise-grid">
            <div class="analise-item">
                <h3>📊 Situação Financeira</h3>
                <p><strong>Saldo Operacional:</strong> ${formatarMoeda(dados.saldo_operacional)}</p>
                <p><strong>Índice de Cobertura:</strong> ${(dados.indice_cobertura * 100).toFixed(1)}%</p>
                <p><strong>Eficiência Operacional:</strong> ${(dados.eficiencia_operacional * 100).toFixed(1)}%</p>
                <div class="status ${dados.saldo_operacional >= 0 ? 'positivo' : 'negativo'}">
                    ${dados.saldo_operacional >= 0 ? '✅ Situação Positiva' : '❌ Situação Crítica'}
                </div>
            </div>
            
            <div class="analise-item">
                <h3>💰 Estrutura de Custos</h3>
                <p><strong>Despesa com Pessoal:</strong> ${formatarMoeda(dados.despesa_pessoal)}</p>
                <p><strong>Despesa com Energia:</strong> ${formatarMoeda(dados.despesa_energia)}</p>
                <p><strong>Despesa Total:</strong> ${formatarMoeda(dados.despesa_total)}</p>
                <p><strong>Investimento Total:</strong> ${formatarMoeda(dados.investimento_total)}</p>
            </div>
            
            <div class="analise-item">
                <h3>📈 Tendências</h3>
                <p><strong>Crescimento Receitas:</strong> ${dados.crescimento_receitas > 0 ? '+' : ''}${(dados.crescimento_receitas * 100).toFixed(1)}%</p>
                <p><strong>Crescimento Despesas:</strong> ${dados.crescimento_despesas > 0 ? '+' : ''}${(dados.crescimento_despesas * 100).toFixed(1)}%</p>
                <p><strong>Capacidade de Investimento:</strong> ${(dados.capacidade_investimento * 100).toFixed(1)}%</p>
            </div>
            
            <div class="analise-item">
                <h3>🎯 Recomendações</h3>
                <ul>
                    ${gerarRecomendacoes(dados)}
                </ul>
            </div>
        </div>
    `;
    
    container.innerHTML = analise;
}

function gerarRecomendacoes(dados) {
    const recomendacoes = [];
    
    if (dados.saldo_operacional < 0) {
        recomendacoes.push('<li>Implementar medidas de redução de custos operacionais</li>');
        recomendacoes.push('<li>Revisar tarifas para garantir cobertura de custos</li>');
    }
    
    if (dados.indice_cobertura < 1) {
        recomendacoes.push('<li>Melhorar eficiência na arrecadação</li>');
        recomendacoes.push('<li>Implementar sistema de cobrança mais eficaz</li>');
    }
    
    if (dados.eficiencia_operacional < 0.8) {
        recomendacoes.push('<li>Otimizar processos operacionais</li>');
        recomendacoes.push('<li>Investir em automação e tecnologia</li>');
    }
    
    if (dados.capacidade_investimento < 0.1) {
        recomendacoes.push('<li>Buscar fontes alternativas de financiamento</li>');
        recomendacoes.push('<li>Estabelecer parcerias público-privadas</li>');
    }
    
    if (recomendacoes.length === 0) {
        recomendacoes.push('<li>Manter as boas práticas atuais</li>');
        recomendacoes.push('<li>Continuar investindo em melhorias</li>');
    }
    
    return recomendacoes.join('');
}

function formatarValor(valor, formato) {
    if (valor === null || valor === undefined) return 'N/A';
    
    switch (formato) {
        case 'moeda':
            return formatarMoeda(valor);
        case 'percentual':
            return `${(valor * 100).toFixed(1)}%`;
        default:
            return valor.toLocaleString('pt-BR');
    }
}

function formatarMoeda(valor) {
    if (valor === null || valor === undefined) return 'N/A';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}
</script>

<style>
.filtros-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: end;
}

.indicadores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.indicador-card {
    text-align: center;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid var(--muted-border-color);
}

.indicador-card.success {
    background: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
}

.indicador-card.warning {
    background: rgba(255, 193, 7, 0.1);
    border-color: #ffc107;
}

.indicador-card.danger {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
}

.indicador-card.info {
    background: rgba(23, 162, 184, 0.1);
    border-color: #17a2b8;
}

.indicador-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: var(--muted-color);
}

.indicador-card .valor {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
}

.chart-container {
    position: relative;
    height: 300px;
}

.ranking-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
}

.ranking-card {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    background: var(--card-background-color);
}

.ranking-position {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary);
    margin-right: 1rem;
    min-width: 2rem;
}

.ranking-info h3 {
    margin: 0;
    font-size: 0.9rem;
}

.ranking-info p {
    margin: 0.25rem 0 0 0;
    font-size: 0.8rem;
    color: var(--muted-color);
}

.analise-detalhada {
    margin-top: 1rem;
}

.analise-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.analise-item {
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    padding: 1.5rem;
    background: var(--card-background-color);
}

.analise-item h3 {
    margin: 0 0 1rem 0;
    color: var(--primary);
    font-size: 1.1rem;
}

.analise-item p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.analise-item ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.analise-item li {
    margin: 0.25rem 0;
    font-size: 0.9rem;
}

.status {
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    text-align: center;
    font-weight: bold;
}

.status.positivo {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid #28a745;
}

.status.negativo {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid #dc3545;
}

.loading {
    text-align: center;
    color: var(--muted-color);
    padding: 2rem;
}

@media (max-width: 768px) {
    .filtros-container {
        flex-direction: column;
    }
    
    .indicadores-grid {
        grid-template-columns: 1fr;
    }
    
    .analise-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %} 