{% extends "base.html" %}

{% block title %}Evolu√ß√£o Temporal - Saneamento Cear√°{% endblock %}

{% block content %}
<div class="container">
    <header class="hero">
        <h1>üìà Evolu√ß√£o Temporal</h1>
        <p>An√°lise da evolu√ß√£o dos indicadores de saneamento ao longo do tempo</p>
    </header>

    <main>
        <!-- Filtros -->
        <section>
            <article>
                <div class="filtros-container">
                    <div class="form-group">
                        <label for="municipio">Munic√≠pio (opcional):</label>
                        <select id="municipio" class="form-control">
                            <option value="">Todos os munic√≠pios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="periodo">Per√≠odo:</label>
                        <select id="periodo" class="form-control">
                            <option value="2019-2022">2019-2022</option>
                            <option value="2020-2022">2020-2022</option>
                            <option value="2021-2022">2021-2022</option>
                        </select>
                    </div>
                    <button id="atualizar-btn" class="btn btn-primary">Atualizar An√°lise</button>
                </div>
            </article>
        </section>

        <!-- Gr√°fico Principal -->
        <section>
            <article>
                <header>
                    <h2>üìä Evolu√ß√£o dos Indicadores</h2>
                </header>
                <div class="chart-container">
                    <canvas id="evolucaoChart"></canvas>
                </div>
            </article>
        </section>

        <!-- Indicadores de Evolu√ß√£o -->
        <section class="grid">
            <article>
                <header>
                    <h2>üìà Taxas de Crescimento</h2>
                </header>
                <div id="taxas-crescimento" class="indicadores-grid">
                    <div class="loading">Carregando...</div>
                </div>
            </article>

            <article>
                <header>
                    <h2>üéØ Metas e Realiza√ß√µes</h2>
                </header>
                <div id="metas-realizacoes" class="metas-container">
                    <div class="loading">Carregando...</div>
                </div>
            </article>
        </section>

        <!-- An√°lise de Tend√™ncias -->
        <section>
            <article>
                <header>
                    <h2>üîç An√°lise de Tend√™ncias</h2>
                </header>
                <div id="analise-tendencias" class="tendencias-container">
                    <div class="loading">Carregando an√°lise...</div>
                </div>
            </article>
        </section>

        <!-- Compara√ß√£o por Regi√£o -->
        <section>
            <article>
                <header>
                    <h2>üó∫Ô∏è Evolu√ß√£o por Regi√£o</h2>
                </header>
                <div class="chart-container">
                    <canvas id="evolucaoRegiaoChart"></canvas>
                </div>
            </article>
        </section>
    </main>
</div>

<script>
let municipios = [];
let dadosEvolucao = {};

document.addEventListener('DOMContentLoaded', function() {
    carregarMunicipios();
    carregarAnaliseEvolucao();
    
    document.getElementById('atualizar-btn').addEventListener('click', carregarAnaliseEvolucao);
    document.getElementById('municipio').addEventListener('change', carregarAnaliseEvolucao);
    document.getElementById('periodo').addEventListener('change', carregarAnaliseEvolucao);
});

async function carregarMunicipios() {
    try {
        const response = await fetch('/api/v1/municipios/');
        municipios = await response.json();
        
        const select = document.getElementById('municipio');
        municipios.forEach(municipio => {
            const option = new Option(municipio.nome, municipio.id_municipio);
            select.add(option);
        });
    } catch (error) {
        console.error('Erro ao carregar munic√≠pios:', error);
    }
}

async function carregarAnaliseEvolucao() {
    const municipio = document.getElementById('municipio').value;
    const periodo = document.getElementById('periodo').value;
    
    try {
        let url = '/api/v1/analises/evolucao-temporal';
        const params = new URLSearchParams();
        
        if (municipio) {
            params.append('municipio_id', municipio);
        }
        if (periodo) {
            params.append('periodo', periodo);
        }
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const response = await fetch(url);
        dadosEvolucao = await response.json();
        
        // Criar gr√°fico principal
        criarGraficoEvolucao(dadosEvolucao);
        
        // Atualizar indicadores
        atualizarTaxasCrescimento(dadosEvolucao);
        atualizarMetasRealizacoes(dadosEvolucao);
        gerarAnaliseTendencias(dadosEvolucao);
        
        // Criar gr√°fico por regi√£o
        criarGraficoEvolucaoRegiao(dadosEvolucao);
        
    } catch (error) {
        console.error('Erro ao carregar an√°lise de evolu√ß√£o:', error);
    }
}

function criarGraficoEvolucao(dados) {
    const ctx = document.getElementById('evolucaoChart').getContext('2d');
    
    if (window.evolucaoChart) {
        window.evolucaoChart.destroy();
    }
    
    window.evolucaoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dados.anos || [],
            datasets: [
                {
                    label: 'Atendimento de √Ågua (%)',
                    data: dados.agua || [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Coleta de Esgoto (%)',
                    data: dados.esgoto || [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Tratamento de Esgoto (%)',
                    data: dados.tratamento || [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolu√ß√£o dos Indicadores de Saneamento'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentual (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Ano'
                    }
                }
            }
        }
    });
}

function atualizarTaxasCrescimento(dados) {
    const container = document.getElementById('taxas-crescimento');
    
    const taxas = [
        {
            nome: 'Crescimento √Ågua',
            valor: dados.taxa_crescimento_agua,
            formato: 'percentual',
            cor: dados.taxa_crescimento_agua > 0 ? 'success' : 'danger'
        },
        {
            nome: 'Crescimento Esgoto',
            valor: dados.taxa_crescimento_esgoto,
            formato: 'percentual',
            cor: dados.taxa_crescimento_esgoto > 0 ? 'success' : 'danger'
        },
        {
            nome: 'Crescimento Tratamento',
            valor: dados.taxa_crescimento_tratamento,
            formato: 'percentual',
            cor: dados.taxa_crescimento_tratamento > 0 ? 'success' : 'danger'
        },
        {
            nome: 'Redu√ß√£o Perdas',
            valor: dados.reducao_perdas,
            formato: 'percentual',
            cor: dados.reducao_perdas > 0 ? 'success' : 'danger'
        }
    ];
    
    container.innerHTML = taxas.map(taxa => `
        <div class="indicador-card ${taxa.cor}">
            <h3>${taxa.nome}</h3>
            <p class="valor">${formatarTaxa(taxa.valor)}</p>
        </div>
    `).join('');
}

function atualizarMetasRealizacoes(dados) {
    const container = document.getElementById('metas-realizacoes');
    
    const metas = [
        {
            nome: 'Meta √Ågua 2022',
            meta: 99,
            realizado: dados.agua_atual,
            cor: dados.agua_atual >= 99 ? 'success' : 'warning'
        },
        {
            nome: 'Meta Esgoto 2022',
            meta: 90,
            realizado: dados.esgoto_atual,
            cor: dados.esgoto_atual >= 90 ? 'success' : 'warning'
        },
        {
            nome: 'Meta Tratamento 2022',
            meta: 80,
            realizado: dados.tratamento_atual,
            cor: dados.tratamento_atual >= 80 ? 'success' : 'warning'
        },
        {
            nome: 'Meta Perdas 2022',
            meta: 20,
            realizado: dados.perdas_atual,
            cor: dados.perdas_atual <= 20 ? 'success' : 'warning'
        }
    ];
    
    container.innerHTML = metas.map(meta => `
        <div class="meta-item ${meta.cor}">
            <h3>${meta.nome}</h3>
            <div class="meta-progresso">
                <div class="meta-barra">
                    <div class="meta-preenchimento" style="width: ${Math.min((meta.realizado / meta.meta) * 100, 100)}%"></div>
                </div>
                <div class="meta-valores">
                    <span class="realizado">${meta.realizado.toFixed(1)}%</span>
                    <span class="meta">Meta: ${meta.meta}%</span>
                </div>
            </div>
        </div>
    `).join('');
}

function gerarAnaliseTendencias(dados) {
    const container = document.getElementById('analise-tendencias');
    
    const analise = `
        <div class="tendencias-grid">
            <div class="tendencia-item">
                <h3>üìà Tend√™ncia Geral</h3>
                <p><strong>Per√≠odo Analisado:</strong> ${dados.periodo_analisado}</p>
                <p><strong>Crescimento M√©dio Anual:</strong> ${formatarTaxa(dados.crescimento_medio_anual)}</p>
                <p><strong>Munic√≠pios com Melhoria:</strong> ${dados.municipios_melhoria} de ${dados.total_municipios}</p>
                <div class="status ${dados.tendencia_geral === 'positiva' ? 'positivo' : 'negativo'}">
                    ${dados.tendencia_geral === 'positiva' ? 'üìà Tend√™ncia Positiva' : 'üìâ Tend√™ncia Negativa'}
                </div>
            </div>
            
            <div class="tendencia-item">
                <h3>üéØ Principais Conquistas</h3>
                <ul>
                    ${gerarConquistas(dados)}
                </ul>
            </div>
            
            <div class="tendencia-item">
                <h3>‚ö†Ô∏è Desafios Identificados</h3>
                <ul>
                    ${gerarDesafios(dados)}
                </ul>
            </div>
            
            <div class="tendencia-item">
                <h3>üöÄ Proje√ß√µes Futuras</h3>
                <p><strong>Proje√ß√£o 2025 - √Ågua:</strong> ${dados.projecao_agua_2025?.toFixed(1) || 'N/A'}%</p>
                <p><strong>Proje√ß√£o 2025 - Esgoto:</strong> ${dados.projecao_esgoto_2025?.toFixed(1) || 'N/A'}%</p>
                <p><strong>Proje√ß√£o 2025 - Tratamento:</strong> ${dados.projecao_tratamento_2025?.toFixed(1) || 'N/A'}%</p>
            </div>
        </div>
    `;
    
    container.innerHTML = analise;
}

function criarGraficoEvolucaoRegiao(dados) {
    const ctx = document.getElementById('evolucaoRegiaoChart').getContext('2d');
    
    if (window.evolucaoRegiaoChart) {
        window.evolucaoRegiaoChart.destroy();
    }
    
    window.evolucaoRegiaoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.regioes || ['Regi√£o 1', 'Regi√£o 2', 'Regi√£o 3', 'Regi√£o 4'],
            datasets: [
                {
                    label: 'Crescimento √Ågua',
                    data: dados.crescimento_regiao_agua || [0, 0, 0, 0],
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1
                },
                {
                    label: 'Crescimento Esgoto',
                    data: dados.crescimento_regiao_esgoto || [0, 0, 0, 0],
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolu√ß√£o por Regi√£o'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Taxa de Crescimento (%)'
                    }
                }
            }
        }
    });
}

function gerarConquistas(dados) {
    const conquistas = [];
    
    if (dados.taxa_crescimento_agua > 0) {
        conquistas.push('<li>Melhoria no atendimento de √°gua</li>');
    }
    if (dados.taxa_crescimento_esgoto > 0) {
        conquistas.push('<li>Expans√£o da coleta de esgoto</li>');
    }
    if (dados.taxa_crescimento_tratamento > 0) {
        conquistas.push('<li>Aumento do tratamento de esgoto</li>');
    }
    if (dados.reducao_perdas > 0) {
        conquistas.push('<li>Redu√ß√£o das perdas de √°gua</li>');
    }
    
    if (conquistas.length === 0) {
        conquistas.push('<li>Manuten√ß√£o dos indicadores</li>');
    }
    
    return conquistas.join('');
}

function gerarDesafios(dados) {
    const desafios = [];
    
    if (dados.agua_atual < 99) {
        desafios.push('<li>Universaliza√ß√£o do acesso √† √°gua</li>');
    }
    if (dados.esgoto_atual < 90) {
        desafios.push('<li>Expans√£o da coleta de esgoto</li>');
    }
    if (dados.tratamento_atual < 80) {
        desafios.push('<li>Aumento do tratamento de esgoto</li>');
    }
    if (dados.perdas_atual > 20) {
        desafios.push('<li>Redu√ß√£o das perdas de √°gua</li>');
    }
    
    if (desafios.length === 0) {
        desafios.push('<li>Manter os bons resultados</li>');
    }
    
    return desafios.join('');
}

function formatarTaxa(valor) {
    if (valor === null || valor === undefined) return 'N/A';
    const sinal = valor > 0 ? '+' : '';
    return `${sinal}${valor.toFixed(1)}%`;
}
</script>

<style>
.filtros-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: end;
}

.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 2rem;
}

.indicadores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.indicador-card {
    text-align: center;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid var(--muted-border-color);
}

.indicador-card.success {
    background: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
}

.indicador-card.danger {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
}

.indicador-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: var(--muted-color);
}

.indicador-card .valor {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
}

.metas-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.meta-item {
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    background: var(--card-background-color);
}

.meta-item.success {
    border-left: 4px solid #28a745;
}

.meta-item.warning {
    border-left: 4px solid #ffc107;
}

.meta-item h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: var(--primary);
}

.meta-progresso {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.meta-barra {
    width: 100%;
    height: 20px;
    background: var(--muted-border-color);
    border-radius: 10px;
    overflow: hidden;
}

.meta-preenchimento {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}

.meta-valores {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.realizado {
    font-weight: bold;
    color: var(--primary);
}

.meta {
    color: var(--muted-color);
}

.tendencias-container {
    margin-top: 1rem;
}

.tendencias-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.tendencia-item {
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    padding: 1.5rem;
    background: var(--card-background-color);
}

.tendencia-item h3 {
    margin: 0 0 1rem 0;
    color: var(--primary);
    font-size: 1.1rem;
}

.tendencia-item p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.tendencia-item ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.tendencia-item li {
    margin: 0.25rem 0;
    font-size: 0.9rem;
}

.status {
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    text-align: center;
    font-weight: bold;
}

.status.positivo {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid #28a745;
}

.status.negativo {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid #dc3545;
}

.loading {
    text-align: center;
    color: var(--muted-color);
    padding: 2rem;
}

@media (max-width: 768px) {
    .filtros-container {
        grid-template-columns: 1fr;
    }
    
    .indicadores-grid {
        grid-template-columns: 1fr;
    }
    
    .tendencias-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %} 