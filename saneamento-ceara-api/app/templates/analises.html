{% extends "base.html" %}

{% block title %}An치lises e Rankings - Saneamento Cear치{% endblock %}

{% block content %}
<div class="container">
    <header>
        <h1>游늵 An치lises e Rankings</h1>
        <p>An치lises comparativas e rankings dos munic칤pios do Cear치</p>
    </header>

    <main>
        <section class="grid">
            <article>
                <header><h2>游끥 Top 5 - Atendimento de 츼gua</h2></header>
                <div id="ranking-agua" class="ranking-container"><div class="loading">Carregando...</div></div>
            </article>

            <article>
                <header><h2>游끥 Top 5 - Coleta de Esgoto</h2></header>
                <div id="ranking-esgoto" class="ranking-container"><div class="loading">Carregando...</div></div>
            </article>
        </section>

        <section>
            <article>
                <header><h2>游늳 Evolu칞칚o Temporal dos Indicadores no Cear치</h2></header>
                <div class="chart-container"><canvas id="evolucaoChart"></canvas></div>
                <div id="evolucao-chart-loading" class="loading" style="display:none;">Carregando gr치fico...</div>
            </article>
        </section>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarRanking('agua', 'indice_atendimento_agua');
    carregarRanking('esgoto', 'indice_coleta_esgoto');
    carregarEvolucaoTemporal();
});

const formatPercent = (num) => num !== null && num !== undefined ? `${num.toFixed(1)}%` : 'N/A';

async function carregarRanking(tipo, indicador) {
    const container = document.getElementById(`ranking-${tipo}`);
    try {
        const response = await fetch(`/api/v1/analises/ranking?indicador=${indicador}&limit=5`);
        if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
        const data = await response.json();
        
        container.innerHTML = data.ranking.map((item, index) => `
            <div class="ranking-item">
                <span><strong>${index + 1}.</strong> ${item.municipio.nome}</span>
                <span class="valor">${formatPercent(item.valor)}</span>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = '<div class="error">Erro ao carregar ranking.</div>';
        console.error(`Erro ao carregar ranking ${tipo}:`, error);
    }
}

async function carregarEvolucaoTemporal() {
    const loading = document.getElementById('evolucao-chart-loading');
    const canvas = document.getElementById('evolucaoChart');
    loading.style.display = 'block';
    canvas.style.display = 'none';

    try {
        const response = await fetch('/api/v1/analises/evolucao-temporal');
        if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
        const data = await response.json();
        
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.anos,
                datasets: [
                    {
                        label: 'Atendimento de 츼gua (%)',
                        data: data.atendimento_agua,
                        borderColor: '#2196F3',
                        tension: 0.1
                    },
                    {
                        label: 'Coleta de Esgoto (%)',
                        data: data.coleta_esgoto,
                        borderColor: '#4CAF50',
                        tension: 0.1
                    },
                    {
                        label: 'Tratamento de Esgoto (%)',
                        data: data.tratamento_esgoto,
                        borderColor: '#FFC107',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
        loading.style.display = 'none';
        canvas.style.display = 'block';
    } catch (error) {
        loading.innerHTML = '<div class="error">Erro ao carregar gr치fico.</div>';
        console.error('Erro ao carregar evolu칞칚o temporal:', error);
    }
}
</script>

<style>
.ranking-container { display: flex; flex-direction: column; gap: 0.5rem; }
.ranking-item { display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #e1e1e1; }
.ranking-item:last-child { border-bottom: none; }
.ranking-item .valor { font-weight: bold; }
.chart-container { position: relative; height: 350px; }
.loading, .error { text-align: center; padding: 2rem; color: #6c757d; }
.error { color: #dc3545; }
</style>
{% endblock %} 