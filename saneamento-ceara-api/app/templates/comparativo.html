{% extends "base.html" %}

{% block title %}Comparativo - Saneamento Cear치{% endblock %}

{% block content %}
<div class="container">
    <header class="hero">
        <h1>游댌 Comparativo entre Munic칤pios</h1>
        <p>Compare indicadores de saneamento entre diferentes munic칤pios do Cear치</p>
    </header>

    <main>
        <!-- Filtros -->
        <section>
            <article>
                <div class="filtros-container">
                    <div class="form-group">
                        <label for="ano">Ano:</label>
                        <select id="ano" class="form-control">
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="municipio1">Munic칤pio 1:</label>
                        <select id="municipio1" class="form-control">
                            <option value="">Selecione um munic칤pio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="municipio2">Munic칤pio 2:</label>
                        <select id="municipio2" class="form-control">
                            <option value="">Selecione um munic칤pio</option>
                        </select>
                    </div>
                    <button id="comparar-btn" class="btn btn-primary">Comparar</button>
                </div>
            </article>
        </section>

        <!-- Resultado da Compara칞칚o -->
        <section id="resultado-comparacao" style="display: none;">
            <article>
                <div class="comparacao-grid">
                    <div class="municipio-card" id="municipio1-card">
                        <header>
                            <h2 id="nome-municipio1">Munic칤pio 1</h2>
                        </header>
                        <div class="indicadores-comparacao">
                            <div class="indicador-comparacao">
                                <span class="label">Atendimento de 츼gua:</span>
                                <span class="valor" id="agua1">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Coleta de Esgoto:</span>
                                <span class="valor" id="esgoto1">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Tratamento de Esgoto:</span>
                                <span class="valor" id="tratamento1">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Perda de Faturamento:</span>
                                <span class="valor" id="perda1">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="municipio-card" id="municipio2-card">
                        <header>
                            <h2 id="nome-municipio2">Munic칤pio 2</h2>
                        </header>
                        <div class="indicadores-comparacao">
                            <div class="indicador-comparacao">
                                <span class="label">Atendimento de 츼gua:</span>
                                <span class="valor" id="agua2">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Coleta de Esgoto:</span>
                                <span class="valor" id="esgoto2">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Tratamento de Esgoto:</span>
                                <span class="valor" id="tratamento2">-</span>
                            </div>
                            <div class="indicador-comparacao">
                                <span class="label">Perda de Faturamento:</span>
                                <span class="valor" id="perda2">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </section>

        <!-- Gr치fico de Compara칞칚o -->
        <section id="grafico-comparacao" style="display: none;">
            <article>
                <header>
                    <h2>游늵 Gr치fico Comparativo</h2>
                </header>
                <div class="chart-container">
                    <canvas id="comparacaoChart"></canvas>
                </div>
            </article>
        </section>

        <!-- An치lise Comparativa -->
        <section id="analise-comparativa" style="display: none;">
            <article>
                <header>
                    <h2>游늳 An치lise Comparativa</h2>
                </header>
                <div id="analise-texto" class="analise-texto">
                    <!-- An치lise ser치 inserida aqui via JavaScript -->
                </div>
            </article>
        </section>
    </main>
</div>

<script>
let municipios = [];
let dadosComparacao = {};

document.addEventListener('DOMContentLoaded', function() {
    carregarMunicipios();
    carregarAnos();
    
    // Event listeners
    document.getElementById('comparar-btn').addEventListener('click', realizarComparacao);
    document.getElementById('ano').addEventListener('change', limparComparacao);
    document.getElementById('municipio1').addEventListener('change', limparComparacao);
    document.getElementById('municipio2').addEventListener('change', limparComparacao);
});

async function carregarMunicipios() {
    try {
        const response = await fetch('/api/v1/municipios/');
        municipios = await response.json();
        
        const select1 = document.getElementById('municipio1');
        const select2 = document.getElementById('municipio2');
        
        municipios.forEach(municipio => {
            const option1 = new Option(municipio.nome, municipio.id_municipio);
            const option2 = new Option(municipio.nome, municipio.id_municipio);
            select1.add(option1);
            select2.add(option2);
        });
    } catch (error) {
        console.error('Erro ao carregar munic칤pios:', error);
    }
}

function carregarAnos() {
    const anoSelect = document.getElementById('ano');
    const anoAtual = new Date().getFullYear();
    
    for (let ano = anoAtual; ano >= 2019; ano--) {
        const option = new Option(ano, ano);
        anoSelect.add(option);
    }
}

async function realizarComparacao() {
    const municipio1 = document.getElementById('municipio1').value;
    const municipio2 = document.getElementById('municipio2').value;
    const ano = document.getElementById('ano').value;
    
    if (!municipio1 || !municipio2) {
        alert('Selecione dois munic칤pios para comparar');
        return;
    }
    
    if (municipio1 === municipio2) {
        alert('Selecione munic칤pios diferentes para comparar');
        return;
    }
    
    try {
        // Buscar dados dos dois munic칤pios
        const [data1, data2] = await Promise.all([
            fetch(`/api/v1/municipios/${municipio1}/indicadores?ano=${ano}`).then(r => r.json()),
            fetch(`/api/v1/municipios/${municipio2}/indicadores?ano=${ano}`).then(r => r.json())
        ]);
        
        dadosComparacao = { municipio1: data1, municipio2: data2 };
        
        // Preencher dados
        preencherDadosComparacao(data1, data2);
        
        // Criar gr치fico
        criarGraficoComparacao(data1, data2);
        
        // Gerar an치lise
        gerarAnaliseComparativa(data1, data2);
        
        // Mostrar resultados
        document.getElementById('resultado-comparacao').style.display = 'block';
        document.getElementById('grafico-comparacao').style.display = 'block';
        document.getElementById('analise-comparativa').style.display = 'block';
        
    } catch (error) {
        console.error('Erro ao realizar compara칞칚o:', error);
        alert('Erro ao realizar compara칞칚o. Tente novamente.');
    }
}

function preencherDadosComparacao(data1, data2) {
    // Munic칤pio 1
    document.getElementById('nome-municipio1').textContent = data1.nome_municipio;
    document.getElementById('agua1').textContent = formatarPercentual(data1.indice_atendimento_agua);
    document.getElementById('esgoto1').textContent = formatarPercentual(data1.indice_coleta_esgoto);
    document.getElementById('tratamento1').textContent = formatarPercentual(data1.indice_tratamento_esgoto);
    document.getElementById('perda1').textContent = formatarPercentual(data1.indice_perda_faturamento);
    
    // Munic칤pio 2
    document.getElementById('nome-municipio2').textContent = data2.nome_municipio;
    document.getElementById('agua2').textContent = formatarPercentual(data2.indice_atendimento_agua);
    document.getElementById('esgoto2').textContent = formatarPercentual(data2.indice_coleta_esgoto);
    document.getElementById('tratamento2').textContent = formatarPercentual(data2.indice_tratamento_esgoto);
    document.getElementById('perda2').textContent = formatarPercentual(data2.indice_perda_faturamento);
    
    // Aplicar classes de destaque
    aplicarDestaqueComparacao('agua', data1.indice_atendimento_agua, data2.indice_atendimento_agua);
    aplicarDestaqueComparacao('esgoto', data1.indice_coleta_esgoto, data2.indice_coleta_esgoto);
    aplicarDestaqueComparacao('tratamento', data1.indice_tratamento_esgoto, data2.indice_tratamento_esgoto);
    aplicarDestaqueComparacao('perda', data2.indice_perda_faturamento, data1.indice_perda_faturamento); // Invertido para perda
}

function aplicarDestaqueComparacao(indicador, valor1, valor2) {
    const elem1 = document.getElementById(`${indicador}1`);
    const elem2 = document.getElementById(`${indicador}2`);
    
    // Remover classes anteriores
    elem1.className = 'valor';
    elem2.className = 'valor';
    
    if (valor1 > valor2) {
        elem1.classList.add('melhor');
        elem2.classList.add('pior');
    } else if (valor2 > valor1) {
        elem2.classList.add('melhor');
        elem1.classList.add('pior');
    }
}

function criarGraficoComparacao(data1, data2) {
    const ctx = document.getElementById('comparacaoChart').getContext('2d');
    
    // Destruir gr치fico anterior se existir
    if (window.comparacaoChart) {
        window.comparacaoChart.destroy();
    }
    
    window.comparacaoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Atendimento de 츼gua', 'Coleta de Esgoto', 'Tratamento de Esgoto', 'Perda de Faturamento'],
            datasets: [
                {
                    label: data1.nome_municipio,
                    data: [
                        data1.indice_atendimento_agua * 100,
                        data1.indice_coleta_esgoto * 100,
                        data1.indice_tratamento_esgoto * 100,
                        data1.indice_perda_faturamento * 100
                    ],
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1
                },
                {
                    label: data2.nome_municipio,
                    data: [
                        data2.indice_atendimento_agua * 100,
                        data2.indice_coleta_esgoto * 100,
                        data2.indice_tratamento_esgoto * 100,
                        data2.indice_perda_faturamento * 100
                    ],
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Compara칞칚o de Indicadores'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentual (%)'
                    }
                }
            }
        }
    });
}

function gerarAnaliseComparativa(data1, data2) {
    const analise = document.getElementById('analise-texto');
    let texto = '<div class="analise-grid">';
    
    // An치lise por indicador
    const indicadores = [
        { nome: 'Atendimento de 츼gua', valor1: data1.indice_atendimento_agua, valor2: data2.indice_atendimento_agua },
        { nome: 'Coleta de Esgoto', valor1: data1.indice_coleta_esgoto, valor2: data2.indice_coleta_esgoto },
        { nome: 'Tratamento de Esgoto', valor1: data1.indice_tratamento_esgoto, valor2: data2.indice_tratamento_esgoto },
        { nome: 'Perda de Faturamento', valor1: data1.indice_perda_faturamento, valor2: data2.indice_perda_faturamento, invertido: true }
    ];
    
    indicadores.forEach(ind => {
        const diferenca = Math.abs(ind.valor1 - ind.valor2);
        const percentualDiferenca = (diferenca * 100).toFixed(1);
        
        let melhor = '';
        if (ind.invertido) {
            melhor = ind.valor1 < ind.valor2 ? data1.nome_municipio : data2.nome_municipio;
        } else {
            melhor = ind.valor1 > ind.valor2 ? data1.nome_municipio : data2.nome_municipio;
        }
        
        texto += `
            <div class="analise-item">
                <h3>${ind.nome}</h3>
                <p><strong>${data1.nome_municipio}:</strong> ${formatarPercentual(ind.valor1)}</p>
                <p><strong>${data2.nome_municipio}:</strong> ${formatarPercentual(ind.valor2)}</p>
                <p><strong>Diferen칞a:</strong> ${percentualDiferenca} pontos percentuais</p>
                <p><strong>Melhor desempenho:</strong> ${melhor}</p>
            </div>
        `;
    });
    
    texto += '</div>';
    analise.innerHTML = texto;
}

function limparComparacao() {
    document.getElementById('resultado-comparacao').style.display = 'none';
    document.getElementById('grafico-comparacao').style.display = 'none';
    document.getElementById('analise-comparativa').style.display = 'none';
}

function formatarPercentual(valor) {
    if (valor === null || valor === undefined) return 'N/A';
    return `${(valor * 100).toFixed(1)}%`;
}
</script>

<style>
.filtros-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: end;
}

.comparacao-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.municipio-card {
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    padding: 1.5rem;
    background: var(--card-background-color);
}

.municipio-card header {
    margin-bottom: 1.5rem;
    text-align: center;
}

.municipio-card h2 {
    margin: 0;
    color: var(--primary);
    font-size: 1.3rem;
}

.indicadores-comparacao {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.indicador-comparacao {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.25rem;
    background: var(--background-color);
}

.label {
    font-weight: bold;
    color: var(--muted-color);
}

.valor {
    font-weight: bold;
    font-size: 1.1rem;
}

.valor.melhor {
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.valor.pior {
    color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 2rem;
}

.analise-texto {
    margin-top: 1rem;
}

.analise-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.analise-item {
    border: 1px solid var(--muted-border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    background: var(--card-background-color);
}

.analise-item h3 {
    margin: 0 0 1rem 0;
    color: var(--primary);
    font-size: 1.1rem;
}

.analise-item p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .filtros-container {
        grid-template-columns: 1fr;
    }
    
    .comparacao-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .analise-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %} 