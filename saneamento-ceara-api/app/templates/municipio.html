{% extends "base.html" %}

{% block title %}Município - {{ municipio.nome }}{% endblock %}

{% block content %}
<article>
    <header>
        <h1>{{ municipio.nome }}</h1>
        <p>Análise detalhada dos indicadores de saneamento para o ano de {{ ano_atual }}</p>
    </header>
    
    <div class="grid">
        <article>
            <h3>Informações Gerais</h3>
            <ul>
                <li><strong>Código IBGE:</strong> {{ municipio.id_municipio }}</li>
                <li><strong>Estado:</strong> {{ municipio.sigla_uf }}</li>
                <li><strong>População (2022):</strong> {{ "{:,.0f}".format(municipio.populacao_total_estimada_2022 or 0).replace(',', '.') }}</li>
                <li><strong>Prestador:</strong> {{ municipio.nome_prestador_predominante or 'N/A' }}</li>
            </ul>
        </article>
        
        <article>
            <h3>Indicadores Atuais ({{ ano_atual }})</h3>
            <div id="indicadores-atuais"><div class="loading">Carregando...</div></div>
        </article>
    </div>
    
    <div class="grid">
        <article>
            <header><h3>Evolução dos Indicadores</h3></header>
            <div class="chart-container"><canvas id="evolucao-municipio"></canvas></div>
        </article>
        
        <article>
            <header><h3>Composição Financeira ({{ ano_atual }})</h3></header>
            <div class="chart-container"><canvas id="indicadores-financeiros"></canvas></div>
        </article>
    </div>
    
    <article>
        <header><h3>Posição no Ranking Estadual ({{ ano_atual }})</h3></header>
        <div class="grid">
             <div>
                <h4>Atendimento de Água</h4>
                <div id="ranking-agua-municipio"><div class="loading">Carregando...</div></div>
            </div>
            <div>
                <h4>Coleta de Esgoto</h4>
                <div id="ranking-esgoto-municipio"><div class="loading">Carregando...</div></div>
            </div>
        </div>
    </article>
</article>
{% endblock %}

{% block extra_scripts %}
<script>
const MUNICIPIO_ID = '{{ municipio.id_municipio }}';
const ANO_ATUAL = '{{ ano_atual }}';
const formatPercent = (num) => num !== null && num !== undefined ? `${num.toFixed(1)}%` : 'N/A';
const formatCurrency = (num) => num !== null && num !== undefined ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num) : 'N/A';

document.addEventListener('DOMContentLoaded', function() {
    carregarDadosPagina();
});

async function carregarDadosPagina() {
    // Busca todos os indicadores de uma vez para eficiência
    const [indicadoresResponse, evolucaoResponse, rankingAguaResponse, rankingEsgotoResponse] = await Promise.allSettled([
        fetch(`/api/v1/municipios/${MUNICIPIO_ID}/indicadores`),
        fetch(`/api/v1/analises/evolucao?municipio_id=${MUNICIPIO_ID}`),
        fetch(`/api/v1/analises/ranking?indicador=indice_atendimento_agua&municipio_id=${MUNICIPIO_ID}`),
        fetch(`/api/v1/analises/ranking?indicador=indice_coleta_esgoto&municipio_id=${MUNICIPIO_ID}`)
    ]);

    // Processar dados dos indicadores (atuais e financeiros)
    if (indicadoresResponse.status === 'fulfilled' && indicadoresResponse.value.ok) {
        const indicadores = await indicadoresResponse.value.json();
        const indicadorAtual = indicadores.find(ind => ind.ano == ANO_ATUAL) || indicadores[0];
        if (indicadorAtual) {
            renderizarIndicadoresAtuais(indicadorAtual);
            renderizarGraficoFinanceiro(indicadorAtual.financeiro);
        } else {
             document.getElementById('indicadores-atuais').innerHTML = '<div class="error">Dados não encontrados para o ano.</div>';
             document.getElementById('indicadores-financeiros').parentElement.innerHTML = '<div class="error">Dados financeiros não encontrados.</div>';
        }
    } else {
        document.getElementById('indicadores-atuais').innerHTML = '<div class="error">Erro ao carregar indicadores.</div>';
    }

    // Processar evolução
    if (evolucaoResponse.status === 'fulfilled' && evolucaoResponse.value.ok) {
        const evolucaoData = await evolucaoResponse.value.json();
        renderizarGraficoEvolucao(evolucaoData.indicadores.evolucao);
    } else {
        document.getElementById('evolucao-municipio').parentElement.innerHTML = '<div class="error">Erro ao carregar evolução.</div>';
    }

    // Processar rankings
    processarRanking('agua', rankingAguaResponse);
    processarRanking('esgoto', rankingEsgotoResponse);
}

function renderizarIndicadoresAtuais(data) {
    const container = document.getElementById('indicadores-atuais');
    container.innerHTML = `
        <div class="indicador-item"><span>Atendimento Água:</span> <strong>${formatPercent(data.indice_atendimento_agua)}</strong></div>
        <div class="indicador-item"><span>Coleta Esgoto:</span> <strong>${formatPercent(data.indice_coleta_esgoto)}</strong></div>
        <div class="indicador-item"><span>Tratamento Esgoto:</span> <strong>${formatPercent(data.indice_tratamento_esgoto)}</strong></div>
        <div class="indicador-item"><span>Perda Faturamento:</span> <strong>${formatPercent(data.indice_perda_faturamento)}</strong></div>
    `;
}

function renderizarGraficoEvolucao(evolucao) {
    const ctx = document.getElementById('evolucao-municipio').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: evolucao.map(item => item.ano),
            datasets: [
                { label: 'Água (%)', data: evolucao.map(item => item.indice_atendimento_agua), borderColor: '#2196F3', tension: 0.1 },
                { label: 'Esgoto (%)', data: evolucao.map(item => item.indice_coleta_esgoto), borderColor: '#4CAF50', tension: 0.1 },
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
    });
}

function renderizarGraficoFinanceiro(financeiro) {
    if (!financeiro) {
        document.getElementById('indicadores-financeiros').parentElement.innerHTML = '<div class="error">Dados financeiros não encontrados.</div>';
        return;
    }
    const ctx = document.getElementById('indicadores-financeiros').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Receita Total', 'Despesa Total', 'Investimento'],
            datasets: [{
                data: [
                    financeiro.receita_operacional_total || 0,
                    financeiro.despesa_total_servicos || 0,
                    financeiro.investimento_total_prestador || 0
                ],
                backgroundColor: ['#4CAF50', '#F44336', '#FFC107']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function processarRanking(tipo, response) {
    const container = document.getElementById(`ranking-${tipo}-municipio`);
    if (response.status === 'fulfilled' && response.value.ok) {
        const data = await response.value.json();
        if (data.posicao_especifica && data.posicao_especifica.posicao) {
            container.innerHTML = `
                <div class="indicador-item">
                    <span>Posição:</span> 
                    <strong>${data.posicao_especifica.posicao}º de ${data.posicao_especifica.total}</strong>
                </div>
                <div class="indicador-item">
                    <span>Valor:</span> 
                    <strong>${formatPercent(data.posicao_especifica.valor)}</strong>
                </div>
            `;
        } else {
             container.innerHTML = '<div class="error">Posição não encontrada.</div>';
        }
    } else {
        container.innerHTML = '<div class="error">Erro ao carregar ranking.</div>';
    }
}
</script>
<style>
.chart-container { position: relative; height: 250px; }
.indicador-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e1e1e1; }
.loading, .error { text-align: center; padding: 2rem; color: #6c757d; }
.error { color: #dc3545; }
</style>
{% endblock %} 